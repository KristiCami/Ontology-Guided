@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix health: <http://example.org/health#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

health:AppointmentShape a sh:NodeShape ;
  sh:targetClass health:Appointment ;
  sh:property [ sh:path health:appointmentPatient ; sh:class health:Patient ; sh:minCount 1 ; sh:maxCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path health:scheduledWith ; sh:class health:Doctor ; sh:minCount 1 ; sh:maxCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path health:scheduledAt ; sh:class health:Clinic ; sh:minCount 1 ] ;
  sh:property [ sh:path health:scheduledStart ; sh:datatype xsd:dateTime ; sh:minCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path health:durationMinutes ; sh:datatype xsd:integer ; sh:minCount 1 ; sh:minInclusive 5 ; sh:severity sh:Violation ] ;
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Clinician and start time must be unique (no double-book)." ;
    sh:prefixes [ sh:declare [ sh:prefix "health" ; sh:namespace "http://example.org/health#"^^xsd:anyURI ] ] ;
    sh:select """
      PREFIX health: <http://example.org/health#>
      SELECT ?this WHERE {
        ?this health:scheduledWith ?c ; health:scheduledStart ?t .
        ?other a health:Appointment ; health:scheduledWith ?c ; health:scheduledStart ?t .
        FILTER(?other != ?this)
      }
    """
  ] .

health:VisitShape a sh:NodeShape ;
  sh:targetClass health:Visit ;
  sh:property [ sh:path health:visitPerformedBy ; sh:class health:Clinician ; sh:minCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path health:visitAt ; sh:class health:Clinic ; sh:minCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path health:visitRoom ; sh:class health:Room ; sh:minCount 1 ] .

health:PrescriptionShape a sh:NodeShape ;
  sh:targetClass health:Prescription ;
  sh:property [ sh:path health:prescriptionMedication ; sh:class health:Medication ; sh:minCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path health:prescribedTo ; sh:class health:Patient ; sh:minCount 1 ; sh:maxCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path health:dosageText ; sh:datatype xsd:string ; sh:minCount 1 ] ;
  sh:property [ sh:path health:frequencyText ; sh:datatype xsd:string ; sh:minCount 1 ] .

health:LabOrderShape a sh:NodeShape ;
  sh:targetClass health:LabOrder ;
  sh:property [ sh:path health:labOrderPatient ; sh:class health:Patient ; sh:minCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path [ sh:inversePath health:hasLabOrder ] ; sh:class health:Visit ; sh:minCount 1 ] ;
  sh:property [ sh:path health:labHasResult ; sh:class health:LabResult ; sh:minCount 1 ; sh:severity sh:Violation ] .

health:LabResultShape a sh:NodeShape ;
  sh:targetClass health:LabResult ;
  sh:property [ sh:path health:resultValue ; sh:datatype xsd:string ; sh:minCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path health:resultDate ; sh:datatype xsd:dateTime ; sh:minCount 1 ] .

health:InsurancePolicyShape a sh:NodeShape ;
  sh:targetClass health:InsurancePolicy ;
  sh:property [ sh:path health:policyNumber ; sh:datatype xsd:string ; sh:minCount 1 ; sh:maxCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path health:payer ; sh:datatype xsd:string ; sh:minCount 1 ] .

health:BillingRecordShape a sh:NodeShape ;
  sh:targetClass health:BillingRecord ;
  sh:property [ sh:path health:billingFor ; sh:class health:Visit ; sh:minCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path health:billingAmount ; sh:datatype xsd:decimal ; sh:minCount 1 ; sh:minInclusive 0 ] ;
  sh:property [ sh:path health:billingStatus ; sh:datatype xsd:string ; sh:minCount 1 ] .

health:VitalSignShape a sh:NodeShape ;
  sh:targetClass health:VitalSignMeasurement ;
  sh:property [ sh:path health:vitalMeasurementOf ; sh:class health:Patient ; sh:minCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path health:measuredBy ; sh:class health:Clinician ; sh:minCount 1 ; sh:severity sh:Violation ] ;
  sh:property [ sh:path health:measurementTime ; sh:datatype xsd:dateTime ; sh:minCount 1 ] ;
  sh:property [ sh:path health:heartRate ; sh:datatype xsd:integer ; sh:minCount 1 ] ;
  sh:property [ sh:path health:systolicBP ; sh:datatype xsd:integer ; sh:minCount 1 ] .
